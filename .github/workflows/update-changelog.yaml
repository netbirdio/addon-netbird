---
name: Update Changelog

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'netbird/Dockerfile'
      - 'netbird/config.yaml'

jobs:
  update-changelog:
    name: Update changelog for NetBird releases
    runs-on: ubuntu-latest
    # Only run on Renovate PRs for NetBird updates
    if: |
      github.actor == 'renovate[bot]' &&
      contains(github.event.pull_request.title, 'netbirdio/netbird')
    permissions:
      contents: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v6.0.2
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract new version from PR
        id: version
        run: |
          # Extract version from config.yaml
          # Strip leading 'v' characters since config.yaml may contain "v0.64.1" but we add 'v' explicitly later
          VERSION=$(grep -m 1 -E '^[[:space:]]*version:' netbird/config.yaml | sed -E 's/^[[:space:]]*version:[[:space:]]*//' | tr -d '"' | tr -d "'" | sed -E 's/^v+//')
          if [ -z "$VERSION" ]; then
            echo "Failed to extract NetBird version from netbird/config.yaml" >&2
            exit 1
          fi
          # Validate that the extracted version looks like a semantic version (e.g., 0.64.1)
          if ! printf '%s\n' "$VERSION" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+'; then
            echo "Invalid NetBird version '$VERSION' extracted from netbird/config.yaml; expected semantic version (e.g., 0.64.1)" >&2
            exit 1
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Detected NetBird version: ${VERSION}"

      - name: Fetch upstream release notes
        id: release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Fetch release notes from upstream repo
          RELEASE_BODY=$(gh api "repos/netbirdio/netbird/releases/tags/v${VERSION}" --jq '.body // empty' 2>/dev/null || echo "")
          RELEASE_DATE=$(gh api "repos/netbirdio/netbird/releases/tags/v${VERSION}" --jq '.published_at // empty' 2>/dev/null | cut -d'T' -f1 || echo "")

          if [ -z "$RELEASE_DATE" ]; then
            echo "Error: Unable to fetch release date for NetBird v${VERSION}. Failing workflow to avoid using an incorrect date in the changelog."
            exit 1
          fi

          echo "release_date=${RELEASE_DATE}" >> "$GITHUB_OUTPUT"

          # Save release body to file for multiline handling
          if [ -n "$RELEASE_BODY" ]; then
            echo "$RELEASE_BODY" > /tmp/release_notes.md
            echo "has_notes=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_notes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Update CHANGELOG.md
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          RELEASE_DATE="${{ steps.release.outputs.release_date }}"
          HAS_NOTES="${{ steps.release.outputs.has_notes }}"
          CHANGELOG_FILE="netbird/CHANGELOG.md"

          # Check if this version already exists in changelog
          if grep -q "## \[v${VERSION}\]" "$CHANGELOG_FILE"; then
            echo "Version v${VERSION} already exists in changelog, skipping..."
            exit 0
          fi

          # Create the new changelog entry
          NEW_ENTRY="## [v${VERSION}] - ${RELEASE_DATE}

          ### Changed
          - Updated to NetBird v${VERSION}
          "

          # Add upstream release notes if available
          if [ "$HAS_NOTES" = "true" ]; then
            NEW_ENTRY="${NEW_ENTRY}
          ### Upstream Release Notes
          "
            # Process release notes - convert to proper markdown format
            while IFS= read -r line; do
              # Skip empty lines at start
              if [ -z "$line" ] && [ -z "${started:-}" ]; then
                continue
              fi
              started=true
              NEW_ENTRY="${NEW_ENTRY}${line}"$'\n'
            done < /tmp/release_notes.md
          fi

          # Insert new entry after the header section (before first existing version entry)
          # Find the line number of the first existing version entry (e.g., "## [v1.2.3]")
          FIRST_VERSION_LINE=$(grep -n '^## \[v' "$CHANGELOG_FILE" | head -n 1 | cut -d: -f1 || true)

          if [ -n "$FIRST_VERSION_LINE" ]; then
            # Insert the new entry before the first existing version entry
            {
              head -n "$((FIRST_VERSION_LINE - 1))" "$CHANGELOG_FILE"
              echo ""
              echo "$NEW_ENTRY"
              tail -n "+$FIRST_VERSION_LINE" "$CHANGELOG_FILE"
            } > "${CHANGELOG_FILE}.tmp"
          else
            # If no version entries are found, append the new entry to the end
            {
              cat "$CHANGELOG_FILE"
              echo ""
              echo "$NEW_ENTRY"
            } > "${CHANGELOG_FILE}.tmp"
          fi
          mv "${CHANGELOG_FILE}.tmp" "$CHANGELOG_FILE"

          echo "Updated changelog with v${VERSION} entry"

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet netbird/CHANGELOG.md; then
            echo "No changelog changes to commit"
            exit 0
          fi

          git add netbird/CHANGELOG.md
          git commit -m "ðŸ“ Update CHANGELOG.md for NetBird v${{ steps.version.outputs.version }}"
          if ! git push; then
            echo "Error: git push failed. Please check the workflow logs, resolve any branch conflicts or permission issues, and retry." >&2
            exit 1
          fi
